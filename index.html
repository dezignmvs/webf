<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Festival Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], poppins: ['Poppins', 'sans-serif'] },
                    colors: {
                        brand: { yellow: '#FCD34D', yellowDark: '#F59E0B', grayBg: '#F9FAFB' }
                    },
                    keyframes: {
                        'scale-up': { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        'fade-in-down': { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    },
                    animation: {
                        'scale-up': 'scale-up 0.2s ease-out',
                        'fade-in-down': 'fade-in-down 0.2s ease-out',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        .page-hidden { display: none !important; opacity: 0; }
        .page-visible { display: flex !important; opacity: 1; transition: opacity 0.3s ease-in-out; }
        
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #FCD34D;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #FCD34D; }
        .toggle-checkbox:checked + .toggle-label { background-color: #FCD34D; }
        
        /* View Toggle Buttons */
        .view-toggle-btn.active { background-color: #FCD34D; color: #111827; font-weight: 600; border-color: #FCD34D; }
        .view-toggle-btn { color: #6B7280; background-color: transparent; font-weight: 500; }
        .view-toggle-btn:hover:not(.active) { background-color: #F3F4F6; color: #374151; }
        
        /* Detail Tabs */
        .detail-tab-btn.active { color: #F59E0B; border-bottom-color: #FCD34D; font-weight: 600; }
        .detail-tab-btn { color: #6B7280; border-bottom: 2px solid transparent; padding-bottom: 1rem; transition: all 0.2s; }

        /* Custom Checkbox */
        .custom-checkbox input:checked + div { background-color: #FCD34D; border-color: #FCD34D; }
        .custom-checkbox input:checked + div i { opacity: 1; }
    </style>
</head>
<body class="bg-brand-grayBg font-sans text-slate-800 h-screen flex overflow-hidden">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-3 items-center pointer-events-none"></div>

    <!-- ERROR BANNER -->
    <div id="db-error-banner" class="hidden fixed bottom-0 left-0 right-0 bg-red-600 text-white p-4 z-[200] shadow-lg">
        <div class="max-w-4xl mx-auto flex items-start justify-between">
            <div><h3 class="font-bold text-lg"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Database Access Denied</h3><p class="text-sm mt-1 opacity-90">Check Firebase Console Rules.</p></div>
            <button onclick="document.getElementById('db-error-banner').classList.add('hidden')" class="text-white hover:text-red-200"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
    </div>

    <!-- =========================== LOGIN PAGE =========================== -->
    <div id="login-page" class="page-visible fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4 overflow-y-auto font-poppins w-full h-full">
        <div class="w-full max-w-[400px] bg-white rounded-[20px] shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-8 md:p-10 space-y-8 relative">
            <div class="flex flex-col items-center text-center space-y-1">
                <h1 id="login-festival-name" class="text-3xl font-bold text-black tracking-tight">Kauthukam.47</h1>
                <h2 id="login-festival-motto" class="text-base font-bold text-gray-900">Refusing to beIgnored</h2>
            </div>
            <form id="login-form" class="space-y-5" onsubmit="window.handleLogin(event)">
                <div class="space-y-1.5">
                    <label class="block text-sm font-bold text-gray-900 ml-1">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-gray-600 focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 outline-none transition-all text-sm" required>
                </div>
                <div class="space-y-1.5">
                    <label class="block text-sm font-bold text-gray-900 ml-1">Password</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-gray-600 focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 outline-none transition-all text-sm pr-10" required>
                        <button type="button" onclick="window.togglePassword()" class="absolute inset-y-0 right-3 flex items-center text-gray-900 hover:text-gray-600"><i id="eye-icon" class="fa-regular fa-eye text-sm"></i></button>
                    </div>
                </div>
                <button id="login-btn" type="submit" class="w-full bg-[#FCD34D] hover:bg-[#fbbf24] text-black font-bold py-3.5 px-4 rounded-xl shadow-sm transition-all transform active:scale-[0.98] text-sm flex justify-center items-center gap-2">
                    <span>Login</span><div id="login-loader" class="loader hidden"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- =========================== DASHBOARD PAGE =========================== -->
    <div id="dashboard-page" class="page-hidden h-full w-full flex overflow-hidden">
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden" onclick="window.toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white w-64 flex-shrink-0 border-r border-gray-200 flex flex-col h-full fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-30">
            <div class="h-16 flex items-center px-6 border-b border-gray-100">
                <div id="sidebar-festival-logo" class="h-8 w-8 rounded-full bg-yellow-400 flex items-center justify-center text-xs font-bold text-white mr-3 uppercase flex-shrink-0">M</div>
                <div class="overflow-hidden">
                    <h1 id="sidebar-festival-name" class="text-sm font-bold text-gray-900 leading-tight truncate">mvs designs</h1>
                    <span id="sidebar-active-status" class="text-xs text-green-500 font-medium">active</span>
                </div>
                <button class="ml-auto text-gray-400 hover:text-gray-600 lg:hidden" onclick="window.toggleSidebar()"><i class="fa-solid fa-chevron-left"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1" id="sidebar-nav">
                <!-- Injected via JS based on Role -->
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <header class="h-16 bg-white lg:bg-transparent lg:px-8 px-4 flex items-center justify-between border-b lg:border-b-0 border-gray-200 flex-shrink-0">
                <div class="flex items-center">
                    <button onclick="window.toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none mr-2"><i class="fa-solid fa-bars text-xl"></i></button>
                    <div class="hidden lg:flex items-center text-gray-400 text-sm">
                        <i class="fa-solid fa-columns mr-2"></i><span class="mr-2">/</span><span class="font-medium text-gray-600" id="header-role-text">Administrator</span>
                    </div>
                </div>
                <div class="relative" id="userMenuContainer">
                    <button onclick="window.toggleUserMenu()" class="flex items-center space-x-2 focus:outline-none hover:bg-gray-50 p-1.5 rounded-lg transition-colors">
                        <div id="header-avatar" class="h-9 w-9 rounded-full bg-yellow-200 flex items-center justify-center text-sm font-bold text-yellow-800 cursor-pointer uppercase">A</div>
                        <span id="header-username" class="hidden lg:block text-sm font-medium text-gray-700">Administrator</span>
                        <i class="fa-solid fa-chevron-down text-xs text-gray-400 hidden lg:block ml-1 transition-transform duration-200" id="userMenuChevron"></i>
                    </button>
                    <div id="userDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-xl border border-gray-100 z-50 transform origin-top-right">
                        <div class="px-5 py-4 border-b border-gray-100 flex items-start gap-3">
                            <div id="dropdown-avatar" class="h-10 w-10 rounded-full bg-yellow-400 flex items-center justify-center text-lg font-bold text-gray-900 flex-shrink-0 uppercase">A</div>
                            <div class="flex flex-col min-w-0">
                                <span id="dropdown-username" class="font-bold text-gray-900 text-sm">Administrator</span>
                                <span id="dropdown-role" class="text-[10px] font-bold text-gray-500 uppercase">Owner</span>
                            </div>
                        </div>
                        <div class="py-2" id="dropdown-actions">
                            <!-- Injected via JS -->
                        </div>
                        <div class="border-t border-gray-100 mt-1 py-2">
                            <button onclick="window.handleLogout()" class="w-full flex items-center px-5 py-2 text-sm font-medium text-red-600 hover:bg-red-50 transition-colors"><i class="fa-solid fa-arrow-right-from-bracket w-5 mr-3 text-center"></i>Signout</button>
                        </div>
                    </div>
                </div>
            </header>

            <main id="main-content-area" class="flex-1 overflow-y-auto p-4 lg:p-8">
                <!-- VIEW: DASHBOARD HOME -->
                <div id="view-home" class="block">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm p-6 relative overflow-hidden flex flex-col justify-center min-h-[200px]">
                            <div class="relative z-10 max-w-md">
                                <h2 class="text-2xl font-bold text-gray-900 mb-2">Welcome to <br/> <span id="dashboard-welcome-name">Your Festival</span></h2>
                                <p class="text-gray-500 text-sm leading-relaxed mb-4">Manage your events and track participants.</p>
                            </div>
                        </div>
                        <div class="lg:col-span-1 grid grid-cols-1 sm:grid-cols-2 gap-4" id="stats-container">
                            <!-- Stats Injected -->
                        </div>
                    </div>
                    <div id="admin-bottom-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Quick Access</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="quick-access-container"></div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="flex justify-between items-end mb-4">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Fest Users</h3>
                                <button onclick="window.openManageModal()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full transition-colors flex items-center shadow-sm"><i class="fa-solid fa-user-plus mr-1"></i>Manage</button>
                            </div>
                            <div id="usersContainer" class="bg-white rounded-2xl shadow-sm p-6 h-auto flex flex-wrap gap-4 min-h-[100px]"></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: DATABASE / ADMIN PANEL -->
                <div id="view-database" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Admin Panel</h2>
                        <button onclick="window.switchView('home')" class="text-sm font-medium text-gray-600 hover:text-gray-900"><i class="fa-solid fa-arrow-left mr-1"></i> Back</button>
                    </div>
                    <div class="flex space-x-6 border-b border-gray-200 mb-6">
                        <button id="tab-users" onclick="window.switchAdminTab('users')" class="pb-3 text-sm font-bold text-yellow-600 border-b-2 border-yellow-400 transition-colors">Users</button>
                        <button id="tab-settings" onclick="window.switchAdminTab('settings')" class="pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">Settings</button>
                    </div>
                    <div id="content-users" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 border-b border-gray-100 uppercase text-xs font-bold text-gray-500 tracking-wider"><tr><th class="px-6 py-4">User</th><th class="px-6 py-4">Role</th><th class="px-6 py-4">Credentials</th><th class="px-6 py-4 text-right">Actions</th></tr></thead><tbody id="database-table-body" class="divide-y divide-gray-100"></tbody></table></div></div>
                    <div id="content-settings" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">Configuration</h3>
                        <div class="max-w-xl space-y-6">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">Name</label><input type="text" id="setting-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">Motto</label><input type="text" id="setting-motto" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm"></div>
                            <div class="flex items-center justify-between pt-4 border-t border-gray-100"><div><h4 class="text-sm font-bold text-gray-900">Active Status</h4></div><div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="setting-active" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="setting-active" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                            <div class="pt-4"><button onclick="window.saveSettings()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-xl shadow-sm transition-colors">Save Changes</button></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: CANDIDATES -->
                <div id="view-candidates" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Candidates</h2>
                        <button onclick="window.openCandidateModal()" class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 text-sm font-bold rounded-lg shadow-sm transition-colors flex items-center"><i class="fa-solid fa-plus mr-2"></i>Add</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col min-h-[500px]">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                            <div class="flex items-center gap-3">
                                <div class="flex items-center bg-gray-50 rounded-lg p-1 border border-gray-200">
                                    <button onclick="window.toggleCandidateView('table')" id="view-toggle-table" class="view-toggle-btn active px-3 py-1.5 rounded-md text-xs flex items-center gap-2"><i class="fa-solid fa-table"></i> Table</button>
                                    <button onclick="window.toggleCandidateView('cards')" id="view-toggle-cards" class="view-toggle-btn px-3 py-1.5 rounded-md text-xs flex items-center gap-2"><i class="fa-solid fa-grip"></i> Cards</button>
                                </div>
                                <div class="flex items-center bg-gray-50 rounded-lg p-1 border border-gray-200">
                                    <button onclick="window.toggleStatusFilter('active')" id="status-toggle-active" class="view-toggle-btn active px-3 py-1.5 rounded-md text-xs">Active</button>
                                    <button onclick="window.toggleStatusFilter('inactive')" id="status-toggle-inactive" class="view-toggle-btn px-3 py-1.5 rounded-md text-xs">Inactive</button>
                                </div>
                            </div>
                            <div class="relative hidden md:block">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input type="text" placeholder="Search..." class="pl-8 pr-4 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-yellow-400 w-48">
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto bg-white">
                            <div id="candidates-table-view" class="w-full">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-50 border-b border-gray-100 uppercase text-xs font-bold text-gray-500 tracking-wider sticky top-0 bg-gray-50 z-10"><tr><th class="px-6 py-4">Candidate</th><th class="px-6 py-4">Team</th><th class="px-6 py-4">Section</th><th class="px-6 py-4 text-right">Actions</th></tr></thead>
                                    <tbody id="candidates-table-body" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                            <div id="candidates-cards-view" class="hidden w-full p-6">
                                <div id="candidates-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SECTIONS -->
                <div id="view-sections" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Sections</h2>
                        <button onclick="window.openSectionModal()" class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 text-sm font-bold rounded-lg shadow-sm"><i class="fa-solid fa-plus mr-2"></i>Add</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 border-b border-gray-100 uppercase text-xs font-bold text-gray-500 tracking-wider"><tr><th class="px-6 py-4">Name</th><th class="px-6 py-4">Status</th><th class="px-6 py-4 text-right">Actions</th></tr></thead>
                            <tbody id="sections-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: TEAMS -->
                <div id="view-teams" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Teams</h2>
                        <button onclick="window.openTeamModal()" class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 text-sm font-bold rounded-lg shadow-sm"><i class="fa-solid fa-plus mr-2"></i>Add</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 border-b border-gray-100 uppercase text-xs font-bold text-gray-500 tracking-wider"><tr><th class="px-6 py-4">Name</th><th class="px-6 py-4">Color</th><th class="px-6 py-4">Status</th><th class="px-6 py-4 text-right">Actions</th></tr></thead>
                            <tbody id="teams-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: CANDIDATE DETAILS -->
                <div id="view-candidate-details" class="hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="window.switchView('candidates')" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-900 shadow-sm"><i class="fa-solid fa-arrow-left text-sm"></i></button>
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-700 font-bold text-lg uppercase" id="detail-avatar">S</div>
                            <div><div class="flex items-center gap-2"><h1 class="text-xl font-bold text-gray-900 uppercase" id="detail-cand-name">Name</h1><span class="px-2 py-0.5 bg-yellow-400 text-gray-900 text-[10px] font-bold rounded uppercase">Active</span></div><div class="flex items-center gap-2 text-xs text-gray-500"><span id="detail-cand-team-sub" class="font-medium">Team</span></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white rounded-2xl border border-gray-100 p-6 h-fit shadow-sm">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-6">Details</h3>
                            <div class="space-y-5 text-sm">
                                <div class="flex justify-between"><span class="text-gray-500">Team</span><span class="font-medium text-gray-900 text-right" id="detail-team">-</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Section</span><span class="font-medium text-gray-900 text-right" id="detail-section">-</span></div>
                                <div class="h-px bg-gray-100 my-2"></div>
                                <div class="flex justify-between"><span class="text-gray-500">Chest No</span><span class="font-medium text-gray-900 text-right" id="detail-chest-no">-</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Ad. No</span><span class="font-medium text-gray-900 text-right" id="detail-ad-no">-</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Class</span><span class="font-medium text-gray-900 text-right" id="detail-class-val">-</span></div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-100 overflow-hidden min-h-[400px] shadow-sm">
                            <div class="flex border-b border-gray-100 px-6 pt-4">
                                <button onclick="window.switchDetailTab('participations')" id="tab-btn-participations" class="detail-tab-btn flex-1 text-center mr-4">Participations</button>
                                <button onclick="window.switchDetailTab('results')" id="tab-btn-results" class="detail-tab-btn flex-1 text-center mr-4">Results</button>
                                <button onclick="window.switchDetailTab('negative')" id="tab-btn-negative" class="detail-tab-btn flex-1 text-center active">Negative Points</button>
                            </div>
                            <div class="p-6">
                                <div id="tab-content-participations" class="hidden text-gray-500 text-sm">No participations yet</div>
                                <div id="tab-content-results" class="hidden text-gray-500 text-sm">No results yet</div>
                                <div id="tab-content-negative" class="block">
                                    <div class="flex justify-between items-center mb-4"><h4 class="font-bold text-gray-900">Negative Points</h4><span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">0 Points</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODALS -->
    <!-- User Modal -->
    <div id="manageModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scale-up">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Add New User</h3><button onclick="window.closeManageModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Name</label><input type="text" id="inputName" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Position</label><select id="inputPosition" onchange="window.handlePositionChange()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white"><option value="" disabled selected>Select Role</option><option value="Admin">Admin</option><option value="Media">Media</option><option value="Team Manager">Team Manager</option></select></div>
                <div id="teamSelectContainer" class="hidden"><label class="block text-xs font-bold text-gray-500 uppercase">Team</label><select id="inputTeam" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white"></select></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button onclick="window.closeManageModal()" class="text-gray-500 font-medium text-sm px-4 py-2 mr-2">Cancel</button><button onclick="window.saveUser()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold text-sm px-6 py-2 rounded-lg">Create User</button></div>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div id="candidateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-up">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800" id="candModalTitle">Add Candidate</h3><button onclick="window.closeCandidateModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="candId">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chest No</label><input type="text" id="candChest" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ad. No</label><input type="text" id="candAdNo" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label><input type="text" id="candName" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Class</label><input type="text" id="candClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Team</label><select id="candTeam" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white"></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Section</label><select id="candSection" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white"></select></div>
                <div class="flex items-center justify-between border-t border-gray-100 pt-4 mt-2"><div><label class="block text-xs font-bold text-gray-500 uppercase">Status</label></div><div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="candStatus" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/><label for="candStatus" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button onclick="window.closeCandidateModal()" class="text-gray-500 font-medium text-sm px-4 py-2 mr-2">Cancel</button><button onclick="window.saveCandidate()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold text-sm px-6 py-2 rounded-lg shadow-sm">Save</button></div>
        </div>
    </div>

    <!-- Section Modal -->
    <div id="sectionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scale-up">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Add Section</h3><button onclick="window.closeSectionModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="sectionId">
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Name</label><input type="text" id="sectionName" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                <div class="flex items-center justify-between border-t border-gray-100 pt-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">Status</label></div><div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="sectionStatus" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/><label for="sectionStatus" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button onclick="window.closeSectionModal()" class="text-gray-500 font-medium text-sm px-4 py-2 mr-2">Cancel</button><button onclick="window.saveSection()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold text-sm px-6 py-2 rounded-lg">Save</button></div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scale-up">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Add Team</h3><button onclick="window.closeTeamModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="teamId">
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Name</label><input type="text" id="teamName" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Color</label><div class="flex items-center gap-2 mt-1"><input type="color" id="teamColor" class="h-10 w-14 rounded cursor-pointer border border-gray-300 p-1" value="#000000"><input type="text" id="teamColorHex" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm uppercase font-mono" value="#000000" readonly></div></div>
                <div class="flex items-center justify-between border-t border-gray-100 pt-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">Status</label></div><div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="teamStatus" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/><label for="teamStatus" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button onclick="window.closeTeamModal()" class="text-gray-500 font-medium text-sm px-4 py-2 mr-2">Cancel</button><button onclick="window.saveTeam()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold text-sm px-6 py-2 rounded-lg">Save</button></div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Edit Credentials</h3><button onclick="window.closeEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-6 space-y-4"><input type="hidden" id="editUserId"><div><label class="block text-xs font-bold text-gray-500 uppercase">Username</label><input type="text" id="editUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Password</label><input type="text" id="editPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div></div><div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button onclick="window.closeEditModal()" class="text-gray-500 font-medium text-sm px-4 py-2 mr-2">Cancel</button><button onclick="window.saveEdit()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold text-sm px-6 py-2 rounded-lg">Update</button></div></div>
    </div>

    <!-- Manage Account Modal -->
    <div id="manageAccountModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Manage Account</h3><button onclick="window.closeManageAccountModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-6 space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">New Username</label><input type="text" id="myUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">New Password</label><input type="text" id="myPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"></div></div><div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button onclick="window.closeManageAccountModal()" class="text-gray-500 font-medium text-sm px-4 py-2 mr-2">Cancel</button><button onclick="window.saveMyAccount()" class="bg-green-500 hover:bg-green-600 text-white font-bold text-sm px-6 py-2 rounded-lg">Save Changes</button></div></div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // UI Helpers
        window.showToast = function(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#10B981' : '#EF4444';
            const iconClass = type === 'success' ? 'fa-check' : 'fa-xmark';
            toast.className = `bg-white text-gray-800 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] border border-gray-100 pointer-events-auto toast-enter`;
            toast.innerHTML = `<div class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: ${bgColor}"><i class="fa-solid ${iconClass} text-white text-xs"></i></div><span class="font-medium text-sm">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2', 'transition-all'); setTimeout(() => { if(container.contains(toast)) container.removeChild(toast); }, 300); }, 3000);
        }

        window.switchView = function(viewName) {
            const views = ['view-home', 'view-database', 'view-candidates', 'view-candidate-details', 'view-sections', 'view-teams'];
            views.forEach(v => document.getElementById(v)?.classList.add('hidden'));
            const target = document.getElementById('view-' + viewName);
            if(target) target.classList.remove('hidden');
        }

        window.togglePassword = function() {
            const input = document.getElementById('password');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash'); } 
            else { input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye'); }
        }

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } 
            else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
        }

        window.toggleUserMenu = function() {
            const menu = document.getElementById('userDropdown');
            const chevron = document.getElementById('userMenuChevron');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) chevron.classList.add('rotate-180'); else chevron.classList.remove('rotate-180');
        }

        // Modal Controls
        const modalIds = ['manageModal', 'candidateModal', 'sectionModal', 'teamModal', 'editModal', 'manageAccountModal'];
        modalIds.forEach(id => {
            window['open' + id.charAt(0).toUpperCase() + id.slice(1)] = () => {
                document.getElementById(id).classList.remove('hidden');
                // Reset fields logic based on ID can be added here or in specific open functions
            };
            window['close' + id.charAt(0).toUpperCase() + id.slice(1)] = () => document.getElementById(id).classList.add('hidden');
        });

        // Specific Open Logic Overrides
        window.openCandidateModal = () => {
            document.getElementById('candModalTitle').textContent="Add Candidate";
            document.getElementById('candId').value='';
            ['candChest','candAdNo','candName','candClass'].forEach(id => document.getElementById(id).value='');
            document.getElementById('candidateModal').classList.remove('hidden');
        };
        window.openSectionModal = () => { document.getElementById('sectionName').value=''; document.getElementById('sectionId').value=''; document.getElementById('sectionModal').classList.remove('hidden'); };
        window.openTeamModal = () => { document.getElementById('teamName').value=''; document.getElementById('teamColor').value='#000000'; document.getElementById('teamId').value=''; document.getElementById('teamModal').classList.remove('hidden'); };
        
        // Color Picker Sync
        document.getElementById('teamColor').addEventListener('input', (e) => document.getElementById('teamColorHex').value = e.target.value);

        // Handle Logout
        window.handleLogout = function() {
            window.toggleUserMenu();
            window.showToast('Logged Out Successfully');
            setTimeout(() => { 
                window.switchView('home'); 
                document.getElementById('login-page').classList.remove('page-hidden'); 
                document.getElementById('login-page').classList.add('page-visible');
                document.getElementById('dashboard-page').classList.add('page-hidden');
                document.getElementById('dashboard-page').classList.remove('page-visible');
            }, 1000);
        }

        // Sidebar Logic
        window.toggleSidebarSubmenu = function(id) {
            const sub = document.getElementById(`submenu-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if(sub.classList.contains('hidden')) { sub.classList.remove('hidden'); arrow.classList.add('rotate-180'); } else { sub.classList.add('hidden'); arrow.classList.remove('rotate-180'); }
        }

        // Candidate View Toggles
        window.currentCandidateView = 'table';
        window.currentCandidateFilter = 'active';
        window.toggleCandidateView = (mode) => {
            window.currentCandidateView = mode;
            document.getElementById('candidates-table-view').className = mode === 'table' ? 'w-full' : 'hidden';
            document.getElementById('candidates-cards-view').className = mode === 'cards' ? 'w-full p-6' : 'hidden';
            document.getElementById('view-toggle-table').classList.toggle('active', mode === 'table');
            document.getElementById('view-toggle-cards').classList.toggle('active', mode === 'cards');
            if(window.renderCandidatesGlobal) window.renderCandidatesGlobal();
        }
        window.toggleStatusFilter = (status) => {
            window.currentCandidateFilter = status;
            document.getElementById('status-toggle-active').classList.toggle('active', status === 'active');
            document.getElementById('status-toggle-inactive').classList.toggle('active', status === 'inactive');
            if(window.renderCandidatesGlobal) window.renderCandidatesGlobal();
        }

        // Tab Logic
        window.switchDetailTab = (tabName) => {
            ['participations', 'results', 'negative'].forEach(t => {
                document.getElementById('tab-btn-' + t).classList.toggle('active', t === tabName);
                const content = document.getElementById('tab-content-' + t);
                if (t === tabName) { content.classList.remove('hidden'); content.classList.add('block'); } 
                else { content.classList.add('hidden'); content.classList.remove('block'); }
            });
        };
        window.switchAdminTab = (tab) => {
            document.getElementById('tab-users').className = tab==='users' ? "pb-3 text-sm font-bold text-yellow-600 border-b-2 border-yellow-400 transition-colors" : "pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors";
            document.getElementById('tab-settings').className = tab==='settings' ? "pb-3 text-sm font-bold text-yellow-600 border-b-2 border-yellow-400 transition-colors" : "pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors";
            document.getElementById('content-users').classList.toggle('hidden', tab!=='users');
            document.getElementById('content-settings').classList.toggle('hidden', tab!=='settings');
        };
    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDkSroz5GsDp5zKW2hIuNl9hpMeun5pyJE", authDomain: "dtbase-fest1.firebaseapp.com", projectId: "dtbase-fest1", storageBucket: "dtbase-fest1.firebasestorage.app", messagingSenderId: "761020619162", appId: "1:761020619162:web:4982fc6db9a80c25808223", measurementId: "G-WKGSBNZ672" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let globalUsersList=[], loggedInUserData=null, candidatesList=[], sectionsList=[], teamsList=[];

        // Auth Logic
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } 
                catch (e) { await signInAnonymously(auth); }
            } else { await signInAnonymously(auth); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                subscribeToUsers(); 
                subscribeToSettings(); 
                subscribeToCandidates(); 
                subscribeToSections(); 
                subscribeToTeams(); 
            } 
        });

        // Subscriptions
        function subscribeToUsers() { onSnapshot(collection(db, 'users'), (s) => { globalUsersList=[]; s.forEach((d) => globalUsersList.push({ id: d.id, ...d.data() })); renderUsersMini(globalUsersList); renderDatabaseTable(globalUsersList); }); }
        function subscribeToSettings() { onSnapshot(doc(db, 'settings', 'general'), (d) => { if (d.exists()) updateUIFromSettings(d.data()); }); }
        function subscribeToCandidates() { onSnapshot(collection(db, 'candidates'), (s) => { candidatesList=[]; s.forEach(d => candidatesList.push({id: d.id, ...d.data()})); renderCandidates(); }); }
        function subscribeToSections() { onSnapshot(collection(db, 'sections'), (s) => { sectionsList=[]; s.forEach(d => sectionsList.push({id: d.id, ...d.data()})); renderSections(); updateDropdowns(); }); }
        function subscribeToTeams() { onSnapshot(collection(db, 'teams'), (s) => { teamsList=[]; s.forEach(d => teamsList.push({id: d.id, ...d.data()})); renderTeams(); updateDropdowns(); }); }

        // Global access for render updates
        window.renderCandidatesGlobal = () => renderCandidates();

        // UI Renderers
        function updateUIFromSettings(data) {
            const name = data.festivalName || "mvs designs";
            document.getElementById('page-title').textContent = `${name} - Dashboard`;
            document.getElementById('login-festival-name').textContent = name;
            document.getElementById('sidebar-festival-name').textContent = name;
            document.getElementById('sidebar-festival-logo').textContent = name.charAt(0).toUpperCase();
            document.getElementById('dashboard-welcome-name').textContent = name;
            document.getElementById('setting-name').value = name;
            document.getElementById('setting-motto').value = data.motto || "active";
            document.getElementById('setting-active').checked = data.isActive !== false;
            
            const statusEl = document.getElementById('sidebar-active-status');
            statusEl.textContent = data.isActive !== false ? 'Active' : 'Inactive';
            statusEl.className = data.isActive !== false ? "text-xs text-green-500 font-medium" : "text-xs text-red-500 font-medium";
        }

        function updateDropdowns() {
            const cTeam = document.getElementById('candTeam'); 
            const uTeam = document.getElementById('inputTeam');
            const cSec = document.getElementById('candSection');
            const teamsOptions = '<option value="">Select Team</option>' + teamsList.filter(t=>t.status==='active').map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
            if(cTeam) cTeam.innerHTML = teamsOptions;
            if(uTeam) uTeam.innerHTML = teamsOptions;
            if(cSec) cSec.innerHTML = '<option value="">Select Section</option>' + sectionsList.filter(s=>s.status==='active').map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
        }

        function renderUsersMini(users) { document.getElementById('usersContainer').innerHTML = users.map(u => `<div class="border border-gray-200 rounded-xl p-4 flex flex-col items-center w-32 relative group bg-white"><div class="h-12 w-12 rounded-full bg-gray-50 border-2 border-gray-100 flex items-center justify-center text-lg font-bold text-gray-600 mb-2 uppercase">${u.avatarLetter}</div><span class="font-bold text-sm text-gray-900 truncate w-full text-center">${u.name}</span><span class="text-xs text-gray-500 truncate w-full text-center">${u.position}</span></div>`).join(''); }
        
        function renderDatabaseTable(users) { 
            document.getElementById('database-table-body').innerHTML = users.map(u => 
                `<tr class="hover:bg-gray-50"><td class="px-6 py-4"><div class="flex items-center"><div class="h-9 w-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 font-bold text-sm mr-3 uppercase">${u.avatarLetter}</div><div><div class="font-bold text-gray-900">${u.name}</div><div class="text-xs text-gray-500">${u.position}</div></div></div></td><td class="px-6 py-4"><span class="px-2 py-1 rounded-md bg-gray-100 text-gray-800 text-xs font-bold">${u.position}</span><div class="text-xs text-gray-500 mt-1">${u.team||'-'}</div></td><td class="px-6 py-4"><span class="text-gray-500 text-xs font-mono">U: ${u.username}</span></td><td class="px-6 py-4 text-right"><button onclick="window.deleteUser('${u.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td></tr>`
            ).join(''); 
        }

        function renderSections() {
            document.getElementById('sections-table-body').innerHTML = sectionsList.length ? sectionsList.map(s => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${s.name}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${s.status==='active'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${s.status}</span></td><td class="px-6 py-4 text-right"><button onclick="window.deleteSection('${s.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('') : '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-400">No sections found</td></tr>';
        }

        function renderTeams() {
            document.getElementById('teams-table-body').innerHTML = teamsList.length ? teamsList.map(t => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${t.name}</td><td class="px-6 py-4"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded border border-gray-200" style="background-color:${t.color}"></div><span class="text-xs text-gray-500 font-mono">${t.color}</span></div></td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${t.status==='active'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${t.status}</span></td><td class="px-6 py-4 text-right"><button onclick="window.deleteTeam('${t.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('') : '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">No teams found</td></tr>';
        }

        function renderCandidates() {
            const list = candidatesList.filter(c => window.currentCandidateFilter === 'active' ? c.status !== 'inactive' : c.status === 'inactive');
            const tableBody = document.getElementById('candidates-table-body');
            const gridBody = document.getElementById('candidates-cards-grid');
            
            if (!list.length) {
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400 text-sm">No candidates found</td></tr>`;
                gridBody.innerHTML = `<div class="col-span-full text-center text-gray-400 py-12">No candidates found</div>`;
                return;
            }

            const teamColorMap = {}; teamsList.forEach(t => teamColorMap[t.name] = t.color);

            // Render Table
            tableBody.innerHTML = list.map(c => {
                const color = teamColorMap[c.team] || '#9CA3AF';
                return `<tr class="hover:bg-gray-50 border-b border-gray-50"><td class="px-6 py-4"><div class="flex items-center gap-3"><div class="h-9 w-9 rounded-full bg-yellow-50 border border-yellow-100 flex items-center justify-center text-yellow-600 font-bold text-xs uppercase">${c.name.charAt(0)}</div><div><span class="font-bold text-gray-900 text-sm uppercase">${c.name}</span><div class="text-xs text-gray-400">#${c.chestNo}</div></div></div></td><td class="px-6 py-4"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2" style="background-color:${color}"></div><span class="text-sm text-gray-700 font-medium">${c.team}</span></div></td><td class="px-6 py-4"><span class="px-3 py-1 rounded-full border border-gray-200 text-xs font-bold text-gray-600 bg-white">${c.section}</span></td><td class="px-6 py-4 text-right"><button onclick="window.viewCandidate('${c.id}')" class="text-gray-400 hover:text-blue-600 mr-2"><i class="fa-regular fa-eye"></i></button><button onclick="window.deleteCandidate('${c.id}')" class="text-gray-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            }).join('');

            // Render Cards
            gridBody.innerHTML = list.map(c => {
                const color = teamColorMap[c.team] || '#9CA3AF';
                return `<div class="border rounded-2xl p-4 relative transition-all hover:shadow-md bg-white group cursor-pointer" onclick="window.viewCandidate('${c.id}')"><div class="flex items-start gap-4"><div class="h-14 w-14 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-700 font-bold text-xl border-4 border-white shadow-sm">${c.name.charAt(0)}</div><div class="flex-1 min-w-0 pt-1"><h3 class="font-bold text-gray-900 truncate uppercase text-sm">${c.name}</h3><p class="text-xs text-gray-400 font-mono mb-2">#${c.chestNo}</p><div class="flex flex-wrap gap-2 mb-1"><span class="px-2 py-0.5 rounded border border-gray-200 text-[10px] font-bold text-gray-600 bg-gray-50">${c.section}</span></div><div class="flex items-center mt-2 gap-2"><div class="w-2 h-2 rounded-full" style="background-color:${color}"></div><span class="text-xs text-gray-600 font-medium truncate">${c.team}</span></div></div></div></div>`;
            }).join('');
        }

        // Sidebar Menu Generator
        window.renderSidebar = (role) => {
            const nav = document.getElementById('sidebar-nav');
            let html = `<p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Menu</p>`;
            html += `<a href="#" onclick="window.switchView('home')" class="flex items-center px-3 py-2 text-sm font-medium text-gray-900 bg-gray-100 rounded-md group mb-2"><i class="fa-solid fa-house w-5 text-center mr-2 text-gray-500 group-hover:text-gray-900"></i>Dashboard</a>`;
            
            const menuItems = [
                { id: 'candidate', icon: 'fa-regular fa-user', label: 'Candidate', items: [
                    {label: 'All Candidates', act: "window.switchView('candidates')"},
                    {label: 'Sections', act: "window.switchView('sections')"},
                    {label: 'Teams', act: "window.switchView('teams')"}
                ]},
                { id: 'programme', icon: 'fa-regular fa-calendar-check', label: 'Programme', items: [{label: 'All Programmes'}] },
                { id: 'schedule', icon: 'fa-regular fa-calendar', label: 'Schedule', items: [{label: 'All Schedules'}] }
            ];

            menuItems.forEach(m => {
                let sub = '';
                m.items.forEach(s => { sub += `<a href="#" onclick="${s.act || '#'}" class="block px-3 py-1.5 text-sm text-gray-500 hover:text-gray-900 hover:bg-gray-50 rounded-md transition-colors">${s.label}</a>`; });
                html += `<div><button onclick="toggleSidebarSubmenu('${m.id}')" class="w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900 rounded-md group justify-between focus:outline-none transition-colors"><div class="flex items-center"><i class="${m.icon} w-5 text-center mr-2 text-gray-400 group-hover:text-gray-600"></i>${m.label}</div><i id="arrow-${m.id}" class="fa-solid fa-chevron-down text-xs text-gray-400 transition-transform duration-200"></i></button><div id="submenu-${m.id}" class="hidden ml-[1.35rem] pl-4 border-l border-gray-200 space-y-1 mt-1">${sub}</div></div>`;
            });
            nav.innerHTML = html;
        }

        window.renderUserDropdown = (role) => {
            const container = document.getElementById('dropdown-actions');
            container.innerHTML = `<button onclick="window.openManageAccountModal()" class="w-full flex items-center px-5 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors group text-left"><i class="fa-regular fa-user w-5 mr-3 text-gray-400 group-hover:text-gray-600 text-center"></i>Manage Account</button>`;
            if (role !== 'Team Manager') {
                container.innerHTML += `<button onclick="window.switchView('database'); window.toggleUserMenu();" class="w-full flex items-center px-5 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors group text-left"><i class="fa-solid fa-database w-5 mr-3 text-gray-400 group-hover:text-gray-600 text-center"></i>Database</button>`;
            }
        };

        // User Actions
        window.handleLogin = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            const loader = document.getElementById('login-loader');
            btn.disabled=true; loader.classList.remove('hidden');

            const user = (u==='administrator' && p==='81119') ? {name:'Administrator', position:'Admin', avatarLetter:'A', username:'administrator'} : globalUsersList.find(x=>x.username===u && x.password===p);
            
            setTimeout(() => {
                if(user) {
                    loggedInUserData = user; 
                    window.renderSidebar(user.position); 
                    window.renderUserDropdown(user.position);
                    document.getElementById('header-username').textContent = user.name;
                    document.getElementById('header-avatar').textContent = user.avatarLetter;
                    document.getElementById('header-role-text').textContent = user.position;
                    document.getElementById('admin-bottom-section').classList.toggle('hidden', user.position === 'Team Manager');
                    window.switchView('home'); 
                    document.getElementById('login-page').classList.remove('page-visible');
                    document.getElementById('login-page').classList.add('page-hidden');
                    document.getElementById('dashboard-page').classList.remove('page-hidden');
                    document.getElementById('dashboard-page').classList.add('page-visible');
                } else window.showToast('Invalid Credentials', 'error');
                btn.disabled=false; loader.classList.add('hidden');
            }, 800);
        };

        window.saveUser = async () => { 
            const name = document.getElementById('inputName').value; 
            const pos = document.getElementById('inputPosition').value; 
            if(!name || !pos) { window.showToast("Fill details", "error"); return; } 
            const u = name.split(' ')[0].toLowerCase() + Math.floor(Math.random()*999); 
            const p = Math.random().toString(36).slice(-6); 
            await addDoc(collection(db, 'users'), { name, position: pos, team: document.getElementById('inputTeam').value, avatarLetter: name[0].toUpperCase(), username: u, password: p }); 
            window.showToast("User Created"); window.closeManageModal(); 
        };
        
        window.deleteUser = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, 'users', id)); };
        
        window.handlePositionChange = () => { document.getElementById('teamSelectContainer').classList.toggle('hidden', document.getElementById('inputPosition').value !== 'Team Manager'); };

        // CRUD Operations
        window.saveCandidate = async () => {
            const data = {
                chestNo: document.getElementById('candChest').value,
                adNo: document.getElementById('candAdNo').value,
                name: document.getElementById('candName').value,
                class: document.getElementById('candClass').value,
                team: document.getElementById('candTeam').value,
                section: document.getElementById('candSection').value,
                status: document.getElementById('candStatus').checked ? 'active' : 'inactive',
                createdAt: new Date().toISOString()
            };
            if(!data.name || !data.chestNo) return window.showToast("Required fields missing", "error");
            await addDoc(collection(db, 'candidates'), data);
            window.showToast("Candidate added"); window.closeCandidateModal();
        };
        window.deleteCandidate = async (id) => { if(confirm("Delete Candidate?")) { await deleteDoc(doc(db, 'candidates', id)); window.showToast("Deleted"); }};
        
        window.viewCandidate = async (id) => {
            const d = await getDoc(doc(db, 'candidates', id));
            if(d.exists()) {
                const data = d.data();
                document.getElementById('detail-cand-name').textContent = data.name;
                document.getElementById('detail-avatar').textContent = data.name.charAt(0);
                document.getElementById('detail-cand-team-sub').textContent = data.team;
                document.getElementById('detail-team').textContent = data.team;
                document.getElementById('detail-section').textContent = data.section;
                document.getElementById('detail-chest-no').textContent = "#"+data.chestNo;
                document.getElementById('detail-ad-no').textContent = data.adNo;
                document.getElementById('detail-class-val').textContent = data.class;
                window.switchView('candidate-details');
            }
        };

        window.saveSection = async () => { 
            const name = document.getElementById('sectionName').value;
            if(!name) return window.showToast("Name required", "error");
            await addDoc(collection(db, 'sections'), { name, status: document.getElementById('sectionStatus').checked ? 'active' : 'inactive' });
            window.showToast("Section added"); window.closeSectionModal();
        };
        window.deleteSection = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, 'sections', id)); };

        window.saveTeam = async () => {
            const name = document.getElementById('teamName').value;
            if(!name) return window.showToast("Name required", "error");
            await addDoc(collection(db, 'teams'), { name, color: document.getElementById('teamColor').value, status: document.getElementById('teamStatus').checked ? 'active' : 'inactive' });
            window.showToast("Team added"); window.closeTeamModal();
        };
        window.deleteTeam = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, 'teams', id)); };
        
        window.saveSettings = async () => {
            try { await setDoc(doc(db, 'settings', 'general'), { festivalName: document.getElementById('setting-name').value, motto: document.getElementById('setting-motto').value, isActive: document.getElementById('setting-active').checked }); window.showToast("Settings Saved"); } catch(e) { window.showToast("Error", "error"); }
        };

        window.saveMyAccount = async () => {
            if (!loggedInUserData?.id) return window.showToast("Admin cannot edit here", "error");
            await updateDoc(doc(db, 'users', loggedInUserData.id), { username: document.getElementById('myUsername').value, password: document.getElementById('myPassword').value });
            window.showToast("Account Updated"); window.closeManageAccountModal();
        };
        window.openEditModal = (id, u, p) => { document.getElementById('editUserId').value=id; document.getElementById('editUsername').value=u; document.getElementById('editPassword').value=p; document.getElementById('editModal').classList.remove('hidden'); };
        window.saveEdit = async () => { await updateDoc(doc(db, 'users', document.getElementById('editUserId').value), { username: document.getElementById('editUsername').value, password: document.getElementById('editPassword').value }); window.showToast("Updated"); document.getElementById('editModal').classList.add('hidden'); };

        // Init Stats
        document.addEventListener('DOMContentLoaded', () => {
            const stats = [
                { title: 'Total Candidates', value: '0', icon: 'fa-solid fa-user-group', color: 'blue' },
                { title: 'Total Programs', value: '0', icon: 'fa-regular fa-calendar', color: 'green' }
            ];
            document.getElementById('stats-container').innerHTML = stats.map(s => `<div class="bg-white p-4 rounded-2xl shadow-sm flex flex-col justify-between"><div class="flex justify-between items-start mb-2"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">${s.title}</span><div class="h-8 w-8 rounded-full bg-${s.color}-50 flex items-center justify-center text-${s.color}-600"><i class="${s.icon} text-xs"></i></div></div><div><span class="text-2xl font-bold text-gray-900">${s.value}</span></div></div>`).join('');
            
            const btns = [{ icon: 'fa-solid fa-user-plus', label: 'Add Candidate', onclick: 'window.openCandidateModal()' }, { icon: 'fa-solid fa-plus-square', label: 'Add Program', onclick: '' }];
            document.getElementById('quick-access-container').innerHTML = btns.map(b => `<button onclick="${b.onclick}" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition-shadow flex flex-col items-center justify-center border border-transparent hover:border-gray-100 group"><div class="h-10 w-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 mb-3 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors"><i class="${b.icon}"></i></div><span class="font-semibold text-gray-700 text-sm">${b.label}</span></button>`).join('');
        });
    </script>
</body>
</html>
